<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronized Highcharts</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <!-- Add any other necessary scripts here -->
</head>
<body>
    <figure class="highcharts-figure">
	<div id="indexChartContainer"></div>
	<div id="windChartContainer"></div>
        <div id="container"></div>
        <p class="highcharts-description">
            Synchronized charts demonstration.
        </p>
    </figure>

    <!-- JavaScript will go here -->
<script>
    ['mousemove', 'touchmove', 'touchstart'].forEach(function (eventType) {
    // Apply event listeners to both containers
    [document.getElementById('container'), document.getElementById('indexChartContainer')].forEach(function(container) {
        container.addEventListener(
            eventType,
            function (e) {
                let chart, point, i, event;

                for (i = 0; i < Highcharts.charts.length; i = i + 1) {
                    chart = Highcharts.charts[i];
                    // Find coordinates within the chart
                    event = chart.pointer.normalize(e);
                    // Get the hovered point
                    point = chart.series[0].searchPoint(event, true);

                    if (point) {
                        point.highlight(e);
                    }
                }
            }
        );
    });
});

/**
 * Override the reset function, we don't need to hide the tooltips and
 * crosshairs.
 */
Highcharts.Pointer.prototype.reset = function () {
    return undefined;
};

/**
 * Highlight a point by showing tooltip, setting hover state and draw crosshair
 */
Highcharts.Point.prototype.highlight = function (event) {
    event = this.series.chart.pointer.normalize(event);
    this.onMouseOver(); // Show the hover marker
    this.series.chart.tooltip.refresh(this); // Show the tooltip
    this.series.chart.xAxis[0].drawCrosshair(event, this); // Show the crosshair
};

/**
 * Synchronize zooming through the setExtremes event handler.
 */
function syncExtremes(e) {
    const thisChart = this.chart;

    if (e.trigger !== 'syncExtremes') { // Prevent feedback loop
        Highcharts.each(Highcharts.charts, function (chart) {
            if (chart !== thisChart) {
                if (chart.xAxis[0].setExtremes) { // It is null while updating
                    chart.xAxis[0].setExtremes(
                        e.min,
                        e.max,
                        undefined,
                        false,
                        { trigger: 'syncExtremes' }
                    );
                }
            }
        });
    }
}

function parseTime(timeStr) {
    const year = parseInt(timeStr.substring(0, 4), 10);
    const month = parseInt(timeStr.substring(4, 6), 10) - 1; // Month is 0-indexed
    const day = parseInt(timeStr.substring(6, 8), 10);
    const hour = parseInt(timeStr.substring(8, 10), 10);
    const minute = parseInt(timeStr.substring(10, 12), 10);
    const second = parseInt(timeStr.substring(12, 14), 10);

    const date = new Date(year, month, day, hour, minute, second);
    return date;
}

function renderWindDirectionArrows(chart) {
    dataJson.timeserie.forEach((item, index) => {
        const windDirection = item.windDegree;
        const x = chart.xAxis[0].toPixels(index) - 10; // Adjust position as needed
        const y = chart.plotHeight + chart.plotTop + 20; // Position below the chart

        // SVG path for an arrow, rotate based on wind direction
        const arrowPath = `M0,0 L0,10 L5,5 L10,10 L10,0 Z`;
        chart.renderer.path(arrowPath)
            .attr({
                'stroke-width': 1,
                stroke: 'black',
                fill: 'black',
                rotation: windDirection,
                translateX: x,
                translateY: y
            })
            .add();
    });
}

// Fetch and parse the JSON data
fetch('https://kunsta-2.github.io/goldenGoose/copen.json')
    .then(response => response.json())
    .then(dataJson => {
        // Parse the data
        const categories = dataJson.timeserie.map(item => parseTime(item.time).toLocaleDateString());
        const times = dataJson.timeserie.map(item => parseTime(item.time).toLocaleTimeString());
        const tempData = dataJson.timeserie.map(item => item.temp);
        const precipData = dataJson.timeserie.map(item => item.precip1);

        // Create the chart
        Highcharts.chart('indexChartContainer', {
        chart: {
            zoomType: 'xy'
        },
        title: {
            text: 'Copenhagen weather, 2021',
            align: 'left'
        },
        subtitle: {
            text: 'Source: ' +
                '<a href="https://www.dmi.dk/lokation/show/DK/2618425/K%C3%B8benhavn/"' +
                'target="_blank">DMI</a>',
            align: 'left'
        },
        xAxis: [{
                categories: categories,
                crosshair: true,
                labels: {
                    formatter: function () {
                        return times[this.value];
                    }
                }
            }],
        yAxis: [{ // Primary yAxis
            labels: {
                format: '{value}°C',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            title: {
                text: 'Temperature',
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            }
        }, { // Secondary yAxis
            title: {
                text: 'Precipitation',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            labels: {
                format: '{value} mm',
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            },
            opposite: true
        }],
        tooltip: {
            shared: true
        },
        legend: {
            align: 'left',
            x: 80,
            verticalAlign: 'top',
            y: 60,
            floating: true,
            backgroundColor:
                Highcharts.defaultOptions.legend.backgroundColor || // theme
                'rgba(255,255,255,0.25)'
        },
        series: [{
            name: 'Precipitation',
            type: 'column',
            yAxis: 1,
            data: precipData,
            tooltip: {
                valueSuffix: ' mm'
            }

        }, {
            name: 'Temperature',
            type: 'spline',
            data: tempData,
            tooltip: {
                valueSuffix: '°C'
            }
            }]
        });
	// Create the wind chart
	Highcharts.chart('windChartContainer', {
	    chart: {
	        type: 'spline'
	    },
	    title: {
	        text: 'Wind Speed and Gust'
	    },
	    xAxis: {
	        categories: categories // Reuse the categories from the temp/precip chart
	    },
	    yAxis: {
	        title: {
	            text: 'Wind Speed (km/h)'
	        }
	    },
	    series: [{
	        name: 'Wind Speed',
	        data: dataJson.timeserie.map(item => item.windSpeed)
	    }, {
	        name: 'Wind Gust',
	        data: dataJson.timeserie.map(item => item.windGust)
	    }]
	    events: {
	        load: function () {
	            renderWindDirectionArrows(this);
	        }
	    }
	});
    })
    .catch(error => {
        console.error('Error fetching or parsing the JSON data:', error);
    });

// Get the data. The contents of the data file can be viewed at
Highcharts.ajax({
    url: 'https://cdn.jsdelivr.net/gh/highcharts/highcharts@v7.0.0/samples/data/activity.json',
    dataType: 'text',
    success: function (activity) {

        activity = JSON.parse(activity);
        activity.datasets.forEach(function (dataset, i) {

            // Add X values
            dataset.data = Highcharts.map(dataset.data, function (val, j) {
                return [activity.xData[j], val];
            });

            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart';
            document.getElementById('container').appendChild(chartDiv);

            Highcharts.chart(chartDiv, {
                chart: {
                    marginLeft: 40, // Keep all charts left aligned
                    spacingTop: 20,
                    spacingBottom: 20
                },
                title: {
                    text: dataset.name,
                    align: 'left',
                    margin: 0,
                    x: 30
                },
                credits: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                xAxis: {
                    crosshair: true,
                    events: {
                        setExtremes: syncExtremes
                    },
                    labels: {
                        format: '{value} km'
                    },
                    accessibility: {
                        description: 'Kilometers',
                        rangeDescription: '0km to 6.5km'
                    }
                },
                yAxis: {
                    title: {
                        text: null
                    }
                },
                tooltip: {
                    positioner: function () {
                        return {
                            // right aligned
                            x: this.chart.chartWidth - this.label.width,
                            y: 10 // align to title
                        };
                    },
                    borderWidth: 0,
                    backgroundColor: 'none',
                    pointFormat: '{point.y}',
                    headerFormat: '',
                    shadow: false,
                    style: {
                        fontSize: '18px'
                    },
                    valueDecimals: dataset.valueDecimals
                },
                series: [{
                    data: dataset.data,
                    name: dataset.name,
                    type: dataset.type,
                    color: Highcharts.getOptions().colors[i],
                    fillOpacity: 0.3,
                    tooltip: {
                        valueSuffix: ' ' + dataset.unit
                    }
                }]
            });
        });
    }
}); // This closing brace was missing

// You can place this function call where you initialize your charts
createIndexChart();

	</script>
</body>
</html>
